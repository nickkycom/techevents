<!DOCTYPE html>
<html lang="en">

<!--JOMC586 Assignment 3: Dynamic Data Dashboard-->
<!--Behind the Bars-->
<!--Nick Shchetko, 2013-->
 
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Behind the Bars | Data Dashboard</title>

<!--CSS: JQUERY, BS3, LOCAL STYLE-->
<link rel="stylesheet" href="css/jquery-ui.css" />
<link href="css/bootstrap.css" rel="stylesheet" type="text/css" />
<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!--[if lt IE 9]>
<script src="../../assets/js/html5shiv.js"></script>
<script src="../../assets/js/respond.min.js"></script>
<![endif]-->
<link href="css/jumbotron-narrow.css" rel="stylesheet" type="text/css" />
<link href="css/jquery.dataTables.css" rel="stylesheet" type="text/css" />
<link rel=stylesheet href="css/flexslider.css" type=text/css>
<link href="css/style.css" rel="stylesheet" type="text/css" />
</head>

<body>  
<!--CONTAINER-->
    <div class="container">
      <div id="jumbo1" class="jumbotron">
        <h1 class="wt-postoni-bold">Behind the Bars</h1>
         <p class="lead margintop">With 2.2 million US residents in prisons and jails across the country, the United States dwarfs other nations by incarceration rates. Explore the data behind prisons and prisoners in our new project.</p>
      </div>
      
      <!--ACCORDION STARTS-->
      <div id="accordion" class="margintop">
	<h2 class="wt-franklin-itc-pro-bold">Facts and Highlights</h2>
	<div>
	    <div class="flex-container">
		<div class="flexslider">
		  <ul class="slides">
		    <li>
		      <img src="slide1.jpg" alt="Window in prison"/>
			<p class="flex-caption"><h4 id="fact1" class="biggerfont wt-franklin-itc-pro-bold">47.7%</h4> percent of state and federal prisoners served sentences in 2010 for violent crimes - murders, manslaughters, rapes, robberies, assaults.</p>
		    </li>
		    <li>
		      <img src="slide2.jpg" alt="Prison cell bars"/>
			<p class="flex-caption"><h4 id="fact2" class="biggerfont wt-franklin-itc-pro-bold">1144</h4> prisoners per 100,000 of adult US population &ndash; in 2011 Louisiana reported the biggest imprisonment rate in the US, 44% higher than the US median (644) and 79% higher than US lowest imprisonment rate of 240 in Minnesota.</p>
		    </li>
		    <li>
		      <img src="slide3.jpg" alt="Four chained inmates"/>
			<p class="flex-caption"><h4 id="fact3" class="biggerfont wt-franklin-itc-pro-bold">99%</h4> of the US prison system capacity is currently in use, the <a href=http://www.prisonstudies.org/info/worldbrief/wpb_country.php?country=190>estimates</a> by the International Centre for Prison Studies show.
		    </li>
		  </ul>
		</div>
	      </div>
	    </div>
	    <h2 class="wt-franklin-itc-pro-bold">US Prisoners: year by year</h2>
	    <div>
	      <p class="wt-franklin">
	      Population of US jails and prisons, from 1980 to 2009
	      <br>&nbsp;<br>
	      </p>
	      <div id="chartdiv" style="width: 100%; height: 362px;"></div>
	      <BR>
	      <p class="smallerfont">Source: <a href=http://felonvoting.procon.org/view.resource.php?resourceID=004353>ProCon.org via US Bureau of Justice Statistics</a>
	    </div>
	    <h2 class="wt-franklin-itc-pro-bold">US Prisoners: state by state</h2>
	    <div>
	      Imprisonment rate in the states: number of incarcerated per 100,000 U.S. residents age 18 or older
	      <br>&nbsp;<br>
	      <div id="mapdiv" style="width: 100%; height: 370px;"></div>
	      <BR>
	      <p class="smallerfont">Note: Jurisdiction refers to the legal authority of state or federal correctional officials over a prisoner  regardless of where the prisoner is held. Counts are based on prisoners with sentences of more than 1 year under the jurisdiction of state or federal correctional officials.</p> 
	      <BR>
	      <p class="smallerfont">Source: <a href=http://www.bjs.gov/index.cfm?ty=pbdetail&iid=4737>US Bureau of Justice Statistics (July 2013)</a></p>
	    </div>
	    <h2 class="wt-franklin-itc-pro-bold">Comparison with other countries</h2>
	    <div>
	      <p class="wt-franklin-itc-pro-light">
	      The excerpts from the <a href=http://www.prisonstudies.org/info/worldbrief/wpb_stats.php?area=all&category=wb_poprate>World Prison Brief Online</a> compiled by experts at the International Centre for Prison Studies reveal incarceration rates from prisons around the globe. See incarceration rates - the number of prisoners per 100,000 of national population - for G8 countries:
	      <br>&nbsp;</br>
	      <table id="table-countries-g8" width="555" border="1" class="wt-franklin-itc-pro-light" cellspacing="0" cellpadding="2">
	  <thead>
	    <tr>
	      <td class="wt-franklin-itc-pro-bold">Country</td>
	      <td class="wt-franklin-itc-pro-bold">Incarceration rate</td>
	    </tr>
	  </thead>
	  <tbody id="table-countries-g8-body">
	  </tbody>
	  </table>
	    <BR>
	      Here's the full list of 221 countries from the report:
	      <br>&nbsp;</br>
	      <table id="table-countries" width="555" border="1" class="margintopsmall wt-franklin-itc-pro-light" cellspacing="0" cellpadding="2">
	  <thead>
	    <tr>
	      <td class="wt-franklin-itc-pro-bold">Country</td>
	      <td class="wt-franklin-itc-pro-bold">Incarceration rate</td>
	    </tr>
	  </thead>
	  <tbody id="table-countries-body">
	    
	  </tbody>
	  </table>
	      </p>
	    </div>
	  </div>
      <!--ACCORDION ENDS-->
      
      <!--FOOTER-->
      <div class="footer">
        <p>It's a non-commerical educational project by Nick Shchetko, October 2013.<BR>The project mimics, in part, <a href=http://www.washingtonpost.com/>Washington Post</a> graphics style for nonprofit educational purposes.<BR>Data sources: <a href=http://www.bjs.gov/index.cfm?ty=daaSearch/Law/Law.cfm>Bureau of Justice Statistics</a> via <a href=https://explore.data.gov/Law-Enforcement-Courts-and-Prisons/Law-Enforcement-Management-and-Administrative-Stat/s8c8-nvzn>Data.gov</a>, <a href=http://www.prisonstudies.org/info/worldbrief/wpb_stats.php?area=all&category=wb_poprate>International Centre for Prison Studies</a>, <a href=http://felonvoting.procon.org/view.resource.php?resourceID=004353>ProCon.org</a>.
      </div>
      <!--FOOTER ENDS-->
      
    </div>
<!--CONTAINER ENDS-->
<!--BODY ENDS-->

<!--JS BLOCK--> 
<script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
<script src="js/jquery-ui.js"></script>
<script src="js/jquery.dataTables.nightly.js" class="jsbin"></script>
<script src="js/ammap.js" type="text/javascript"></script>
<script src="js/usaLow.js" type="text/javascript"></script>
<script src="js/amcharts.js" type="text/javascript"></script>
<script src="js/amcharts_serial.js" type="text/javascript"></script>
<script src="js/jquery.flexslider-min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript">
  //main declarations
  var parsePattern = ""; //what rule use to parse an XML
  var mapAreas = []; // an array of arrays, read from the XML and transferred to amMaps
  var chartData = []; // an array of arrays, read from the XML and transferred to amCharts
  var featureDB = []; // an array of arrays, read from the XML and then publish it to placeholders
  
    $(document).ready(function(){
      //Main flow
      //Populating elements through XML
      
      doXml("Countries"); // for the datatables
      doXml("States"); // for the heatmap
      doXml("Years"); // for the chart
      doXml("Features"); // for the datatables (featured)
                
      //Accordion init
      var icons = {
        header: "ui-icon-circle-triangle-e",
        activeHeader: "ui-icon-circle-triangle-s"
       };
      $("#accordion").accordion({
        collapsible: true, icons: icons, active: 0, heightStyle: "content",
	// Below is the workaround to properly show map and chart in tab2-3 - it can only be drawn after
	// the tab with it opened; so ideally it should also check the id of the tab activated, not just redraw on any tab activation
	activate: function (event, ui) { map.write("mapdiv"); chart.write("chartdiv"); }
      });
      
      //Doing the heatmap, amMap; mapAreas is populated in doXml("States")
      var map;
      AmCharts.ready(function() {
	  map = new AmCharts.AmMap();
	  map.pathToImages = "http://www.ammap.com/lib/3/images/";
	  map.panEventsEnabled = true; // this line enables pinch-zooming and dragging on touch devices
	  map.colorSteps = 6;
	  map.balloon.color = "#000000";
	   if (mapAreas.length==0) {
	    //let's reread
	    console.log ("Problem encountered, re-reading the data");
	    doXml("States");
	   }
	  var dataProvider = {
	      mapVar: AmCharts.maps.usaLow,
	      areas: mapAreas
	        };
		
	  map.areasSettings = {
	      autoZoom: true,
	      color: "#e6e6e6",
	      colorSolid: "#333333",
	      rollOverColor: "#CC3333",
	      SelectedColor: "#CC3333",
	      balloonText: "[[title]]: [[value]] prisoners per 100,000 U.S. resident adults"
	  };
	  map.dataProvider = dataProvider;
	  map.fontFamily = "FranklinITCProThin, Helvetica, Arial, sans-serif;";
	  map.fontSize = 12;
  	  map.zoomControl.buttonFillAlpha = 0.3;
	  map.zoomControl.buttonBorderAlpha = 0.2;
	  var valueLegend = new AmCharts.ValueLegend();
	  valueLegend.right = 10;
	  map.valueLegend = valueLegend;
      
	  map.write("mapdiv");
      });
     
      //Charts
      var chart;
      var graph;
      
      AmCharts.ready(function () {
      // SERIAL CHART
	  chart = new AmCharts.AmSerialChart();
	  chart.pathToImages = "http://www.amcharts.com/lib/3/images/";
	  chart.dataProvider = chartData;
	  chart.marginLeft = 10;
	  chart.categoryField = "year";
	  chart.dataDateFormat = "YYYY";
	  chart.fontFamily = "FranklinITCProThin, Helvetica, Arial, sans-serif;";
	  chart.fontSize = 12;
	  
	  
	// AXES
	  // category
	  var categoryAxis = chart.categoryAxis;
	  categoryAxis.parseDates = true; // as our data is date-based, we set parseDates to true
	  categoryAxis.minPeriod = "YYYY"; // our data is yearly, so we set minPeriod to YYYY
	  categoryAxis.dashLength = 1;
	  categoryAxis.axisAlpha = 0;
	  categoryAxis.inside = 1;
	  categoryAxis.offset = -10;
	  
	  // value
	  var valueAxis = new AmCharts.ValueAxis();
	  valueAxis.axisAlpha = 0;
	  valueAxis.inside = true;
	  valueAxis.dashLength = 0.5;
	  chart.addValueAxis(valueAxis);
	  
	  // GRAPH                
	  graph = new AmCharts.AmGraph();
	  graph.type = "smoothedLine"; // this line makes the graph smoothed line.
	  graph.lineColor = "#d1655d";
	  graph.negativeLineColor = "#637bb6"; // this line makes the graph to change color when it drops below 0
	  graph.bullet = "round";
	  graph.bulletSize = 0;
	  graph.bulletBorderColor = "#FFFFFF";
	  graph.bulletBorderAlpha = 1;
	  graph.bulletBorderThickness = 2;
	  graph.lineThickness = 5;
	  graph.valueField = "value";
	  graph.balloonText = "[[category]]<br><b><span style='font-size:14px;'>[[value]]</span></b>";
	  chart.addGraph(graph);
	  
	  // CURSOR
	  var chartCursor = new AmCharts.ChartCursor();
	  chartCursor.cursorAlpha = 0;
	  chartCursor.cursorPosition = "mouse";
	  chartCursor.categoryBalloonDateFormat = "YYYY";
	  chart.addChartCursor(chartCursor);
	  
	  // WRITE
	  chart.write("chartdiv");
      });

    
     // plugin slider
       $(window).load(function() {
       $('.flexslider').flexslider({
       randomize: true,
	   slideshow: true,   
	   controlNav: false,
	   directionNav: true
       });
       }); 
      
      
      //***
      //***
      //end of DocumentReady main flow
      //***
      //***
   });


//***
//Start of additional functions
//***

function doXml(keyCode) {
  // loads XML and passes it to parser, based on keyCode
  // keyCode = Countries (Datatable), States (Map), Years (Chart), Features (Featured data)
  
    if (keyCode=="Countries") {
      //console.log("patternCountries fired");
      myFileUrl = "data/prisoners-by-country.xml";
      parsePattern = "patternCountries";
      
      $.ajax({
	type:"GET",
	url:myFileUrl,
	dataType: "xml",
	success: parseXmlCountries
	//what to do next
     })
    }
    
        if (keyCode=="States") {
      //console.log("patternStates fired");
      myFileUrl = "data/prisoners-by-state.xml";
      parsePattern = "patternStates";
      
      $.ajax({
	type:"GET",
	url:myFileUrl,
	dataType: "xml",
	success: parseXmlStates
	//what to do next
     })
    }
    
        if (keyCode=="Years") {
      console.log("patternYears fired");
      parsePattern = "patternYears";
      myFileUrl = "data/prisoners-by-year.xml";
      
      $.ajax({
	type:"GET",
	url:myFileUrl,
	dataType: "xml",
	success: parseXmlYears
	//what to do next
     })
    }
    
        if (keyCode=="Features") {
console.log("patternFeatures fired");
      parsePattern = "patternFeatures";
      myFileUrl = "data/prisoners-by-country-g8.xml";
  
      $.ajax({
	type:"GET",
	url:myFileUrl,
	dataType: "xml",
	success: parseXmlFeatures
	//what to do next
     })
    }

} //close loadXML

function parseXmlCountries(xml){
//parsing XML here; Countries
        var generated="";

      	//parsing through the XML
	$(xml).find("country").each(function(index){
          var name = $(this).find('name').text();
          var url = $(this).find('url').text();
	  var prisonercount = $(this).find('prisoners').text();
	  generated = '<tr>';
          generated += '<td><a href="' + url + '">' + name + '</a></td>';
          generated += '<td>' + prisonercount + '</td></tr>';
	  $("#table-countries").append(generated);
	})
	
        //Table Countries
	//no stripes, "responsive"
	$('#table-countries').dataTable(
	{
	  "aaSorting": [[ 1, "desc" ]],
	  "asStripeClasses":[],
	  "bAutoWidth": false
	} );
	
}    
    
function parseXmlStates(xml){
      var j=0;
      
      //parsing through countries XML
      $(xml).find("state").each(function(index){
          var code = $(this).find('code').text();
          var prisonercount = $(this).find('prisonercount').text();
	  
	  //populating map area data provider
	  mapAreas[j] = {
	    id: code,
	    value: prisonercount
	  };
	j++;
	})
      
      parsePattern = ""; //make the keycode blank again
}
    

function parseXmlYears(xml){
      var k=0;
      
      //parsing through countries XML
      $(xml).find("dataentry").each(function(index){
	  var year = $(this).find('year').text();
	  var total = $(this).find('total').text();
	  chartData[k] = {
        year: year,
        value: total
        };
        k++;
      })
	
       parsePattern = "";
}

function parseXmlFeatures(xml){
//parsing XML here; Features (G8, shortened version of the full country dataset)
	console.log("parseXML() started - Features");
	var generatedg8 = 0;
	
      	//parsing through the XML
	$(xml).find("country").each(function(index){
          var nameg8 = $(this).find('name').text();
          var urlg8 = $(this).find('url').text();
	  var prisonercountg8 = $(this).find('prisoners').text();
	  generatedg8 = '<tr>';
          generatedg8 += '<td><a href="' + urlg8 + '">' + nameg8 + '</a></td>';
          generatedg8 += '<td>' + prisonercountg8 + '</td></tr>';
	  $("#table-countries-g8").append(generatedg8);
	})
	
	//Table Countries: G8
	$('#table-countries-g8').dataTable(
	{
	  "aaSorting": [[ 1, "desc" ]],
	  "asStripeClasses":[],
	  "bPaginate": false,
	  "bFilter": false,
	  "bInfo": false,
	  "bAutoWidth": false
	} );
	
	parsePattern = "";
}    
//end of XML parser functions
//end of Javasript
</script>
</body>
</html>